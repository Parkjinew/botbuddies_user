<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smhrd.botbuddies.mapper.UserMapper">
<select id="selectUser" resultType="com.smhrd.botbuddies.entity.User">
select * from USERS
</select>

<select id="signin" parameterType='String' resultType="com.smhrd.botbuddies.entity.User">
select * from USERS where user_id = #{id} and user_pw = MD5(#{password}) and user_role='2'
</select>


<select id="favorite" parameterType='String' resultType="com.smhrd.botbuddies.entity.User">
SELECT 
    s.store_name, 
    ANY_VALUE(s.store_seq) AS store_seq, 
    s.category_seq,
    MIN(s.open_time) AS open_time, -- 집계 함수 사용
    MAX(s.end_time) AS end_time, -- 집계 함수 사용
    ROUND(AVG(r.score),1) AS AverageRating, 
    COUNT(r.title) AS ReviewCount, 
    ANY_VALUE(mi.img_filename) AS STORE_IMG 
FROM 
    USERS m 
INNER JOIN 
    INTEREST i ON m.user_id = i.user_id 
INNER JOIN 
    STORES s ON i.store_seq = s.store_seq 
LEFT JOIN 
    REVIEWS r ON s.store_seq = r.store_seq 
LEFT JOIN 
    STORE_IMG mi ON s.store_seq = mi.store_seq 
WHERE 
    m.user_id = #{id}
GROUP BY 
    s.store_name, s.category_seq
LIMIT 0, 1000
</select>

<select id="orderlist" parameterType="String" resultType="com.smhrd.botbuddies.entity.Order">
SELECT
    s.store_name,
    o.order_num,
	o.total_amount,
    GROUP_CONCAT(DISTINCT m.menu_name) AS menu_names,
    GROUP_CONCAT(DISTINCT si.img_filename) AS image_filenames
FROM
    ORDERS o
JOIN
    MENUS m ON o.store_seq = m.store_seq
JOIN
    STORES s ON o.store_seq = s.store_seq
JOIN
    STORE_IMG si ON s.store_seq = si.store_seq
WHERE
    o.user_id = #{id}
GROUP BY
    o.order_num, s.store_name, o.total_amount
LIMIT 0, 1000
</select>

</mapper>